<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Request Form (MRF) - DS Project Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Arial+Narrow:wght@400;700&display=swap" rel="stylesheet">

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Apply dark mode based on system preference or saved setting (from index.html)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        /* --- Structural & Non-Color Styles from index.html --- */
        #side-nav {
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }

            #side-nav.nav-collapsed {
                width: 4rem; /* 64px */
            }

                #side-nav.nav-collapsed .nav-link-text,
                #side-nav.nav-collapsed #nav-content > ul,
                #side-nav.nav-collapsed #settings-submenu,
                #side-nav.nav-collapsed .nav-section-title {
                    display: none;
                }

                #side-nav.nav-collapsed .nav-link,
                #side-nav.nav-collapsed #settings-toggle-btn {
                    justify-content: center;
                }

                    #side-nav.nav-collapsed #settings-toggle-btn .nav-link-text {
                        display: none;
                    }

        .modal {
            z-index: 50;
        }

        .feedback {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            font-size: 0.875rem;
            display: none;
        }

        .feedback-success {
            background-color: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }

        .dark .feedback-success {
            background-color: #166534;
            border-color: #4ade80;
            color: #dcfce7;
        }

        .feedback-error {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }

        .dark .feedback-error {
            background-color: #991b1b;
            border-color: #f87171;
            color: #fee2e2;
        }

        .feedback-info {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
        }

        .dark .feedback-info {
            background-color: #1e40af;
            border-color: #60a5fa;
            color: #dbeafe;
        }

        .feedback-warning {
            background-color: #fef3c7;
            border-color: #fcd34d;
            color: #92400e;
        }

        .dark .feedback-warning {
            background-color: #92400e;
            border-color: #fbbf24;
            color: #fef3c7;
        }

        .main-content-area {
            overflow-y: auto;
        }

        .table-container {
            overflow-x: auto;
        }

        .button {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        .button-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }
        /* ... (other button color styles from index.html can be added here if needed, or rely on Tailwind) ... */

        /* --- Styles specific to MRF Form --- */
        .mrf-body-font { /* Applied to the form-container to scope MRF fonts */
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

        .form-container {
            max-width: 1200px;
            margin: 1.5rem auto; /* Centered within the main content area */
            padding: 1.5rem;
            background-color: #ffffff; /* White background for the form itself */
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

            .form-container th, .form-container td { /*Scoped to MRF table*/
                padding: 0.3rem 0.25rem;
                text-align: left;
                border: 1px solid #e2e8f0;
                font-size: 0.7rem;
                vertical-align: top;
            }

            .form-container th {
                background-color: #f8fafc;
                font-weight: 600;
                color: #334155;
                font-size: 0.65rem;
                white-space: nowrap;
            }

            .form-container table {
                border-collapse: collapse;
                width: 100%;
            }

            .form-container .header-section {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.75rem 1.5rem;
                align-items: start;
                margin-bottom: 1.5rem;
            }

        @media (min-width: 1024px) {
            .form-container .header-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-container .header-section dl {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.1rem 0.5rem;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .form-container .header-section dt {
            font-weight: 600;
            color: #475569;
            font-size: 0.75rem;
            padding-right: 0.5rem;
            white-space: nowrap;
            align-self: center;
        }

        .form-container .header-section dd {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e2e8f0; /* Default border for dd */
        }

        .form-container .header-section input[type="text"],
        .form-container .header-section input[type="date"],
        .form-container .header-section select,
        .form-container .header-section .header-static-prefix {
            color: #1e293b;
            border: none;
            padding: 0.25rem 0.1rem;
            border-radius: 0;
            font-size: 0.75rem;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
            background-color: transparent;
            box-shadow: none;
            outline: none;
            min-height: calc(0.75rem + 0.25rem * 2 + 1px);
        }

        .form-container .header-section .header-static-prefix {
            background-color: #f9fafb; /* Light gray for prefix span */
            color: #374151;
            padding-right: 0.05rem;
            white-space: nowrap;
        }

        .form-container .header-section #formNoSuffix {
            flex-grow: 1;
            border: none;
            padding: 0.25rem 0.1rem;
            font-size: 0.75rem;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
            background-color: #fff; /* White for editable suffix */
            outline: none;
        }

            .form-container .header-section #formNoSuffix:focus {
                box-shadow: 0 0 0 1px #3b82f6;
            }

        .form-container .header-section input[readonly],
        .form-container .header-section select[disabled] {
            background-color: #f9fafb; /* Light gray for readonly/disabled */
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-container .header-section dl dd > input[type="text"]:not(#formNoSuffix),
        .form-container .header-section dl dd > input[type="date"],
        .form-container .header-section dl dd > select {
            width: 100%;
        }

        .form-container .table-input {
            width: 100%;
            min-width: 40px;
            padding: 0.2rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

            .form-container .table-input.number-input {
                text-align: right;
            }

            .form-container .table-input:read-only {
                background-color: #f3f4f6;
                color: #6b7280;
                cursor: not-allowed;
            }

        .form-container .action-button {
            background-color: #dc2626;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.65rem;
            border: none;
            cursor: pointer;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

            .form-container .action-button:hover {
                background-color: #b91c1c;
            }

        .form-container .add-row-button {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

            .form-container .add-row-button:hover {
                background-color: #1d4ed8;
            }

        .form-container .control-button {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.5rem;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

        .form-container .export-button {
            background-color: #10b981;
        }

            .form-container .export-button:hover {
                background-color: #059669;
            }

        .form-container .pdf-export-button {
            background-color: #ef4444;
        }

            .form-container .pdf-export-button:hover {
                background-color: #dc2626;
            }

        .form-container .save-data-button {
            background-color: #3b82f6;
        }

            .form-container .save-data-button:hover {
                background-color: #2563eb;
            }

        .form-container .load-data-button {
            background-color: #f59e0b;
        }

            .form-container .load-data-button:hover {
                background-color: #d97706;
            }

        .form-container .footer-input {
            margin-top: 0.1rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            font-size: 0.75rem;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

            .form-container .footer-input:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 1px #3b82f6;
            }

        .static-text-value {
            display: inline-block;
            padding: 0.3rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1.3;
            white-space: pre-wrap;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

            .static-text-value.footer-static {
                display: block;
                padding: 0.1rem 0.25rem;
                font-size: 0.75rem;
                margin-top: 0.05rem;
                line-height: 1.2;
            }

            .static-text-value.footer-label-static {
                margin-bottom: 0.3rem;
            }

        .table-input-static {
            display: inline-block;
            padding: 0.2rem;
            font-size: 0.7rem;
            line-height: 1.3;
            white-space: pre-wrap;
            font-family: 'Arial Narrow', 'Inter', sans-serif;
        }

            .table-input-static.number-input {
                text-align: right;
            }


        @media print {
            body {
                font-family: 'Arial Narrow', 'Inter', sans-serif !important;
                background-color: #ffffff;
                font-size: 8pt;
            }

            .form-container {
                margin: 0;
                padding: 0.5cm;
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
                background-color: #ffffff !important;
            }

            .no-print, #side-nav, .app-header /* Hide app header as well */ {
                display: none !important;
            }

            main.main-content-area {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            /* Adjust main content for print */
            .form-container th, .form-container td {
                font-size: 7pt;
                padding: 0.1rem;
                border: 1px solid #ccc !important;
            }

            .form-container table {
                width: 100% !important;
                border-collapse: collapse;
            }

            .form-container .header-section input,
            .form-container .header-section select,
            .form-container .header-section textarea,
            .form-container .table-input,
            .form-container .footer-input,
            .form-container .header-section .header-static-prefix,
            .form-container .header-section #formNoSuffix,
            #formNoSuffixStaticPrint {
                border: none !important;
                padding: 0.05rem !important;
                background-color: transparent !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                font-family: 'Arial Narrow', 'Inter', sans-serif !important;
                box-shadow: none !important;
                margin-top: 0.05rem !important;
                font-size: 8pt !important;
                display: inline !important;
                vertical-align: baseline !important;
            }

            .form-container .header-section dd {
                border-bottom: none !important;
            }

            .form-container .header-section input[readonly],
            .form-container .header-section select[disabled] {
                background-color: transparent !important;
            }

            .form-container .table-input:read-only {
                background-color: transparent !important;
            }

            .form-container .footer-label-print {
                margin-bottom: 0.3rem !important;
                font-size: 8pt !important;
            }

            .static-text-value.footer-label-static {
                margin-bottom: 0.3rem !important;
                font-size: 8pt !important;
            }

            .static-text-value.footer-static {
                font-size: 8pt !important;
                padding: 0.05rem 0.1rem;
            }

            .mrf-logo {
                max-height: 40px !important;
                width: auto !important;
            }

            .header-static-print {
                font-size: 8pt !important;
                padding: 0.05rem !important;
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-slate-300 font-[Inter,sans-serif] flex flex-col min-h-screen">

    <header class="app-header flex justify-between items-center py-3 border-b bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700 px-4 md:px-6 lg:px-8 sticky top-0 z-20 flex-shrink-0 shadow-sm no-print">
        <div class="title-container flex items-center space-x-3">
            <img src="/static/CMRP Logo Dark.svg" alt="CMRP Logo Dark" class="header-logo h-8 w-auto block dark:hidden">
            <img src="/static/CMRP Logo Dark.svg" alt="CMRP Logo Dark" class="header-logo h-8 w-auto hidden dark:block">
            <div style="display: none;" class="logo-fallback h-8 w-8 bg-blue-200 dark:bg-sky-700 rounded flex items-center justify-center text-sm font-bold text-blue-700 dark:text-sky-200">DS</div>
            <h1 class="text-xl font-semibold text-gray-800 dark:text-slate-200">CMRP Project Monitoring</h1>
            <script>
                document.querySelectorAll('.header-logo').forEach(logoImg => {
                    logoImg.onerror = () => {
                        logoImg.style.display = 'none';
                        const fallback = logoImg.parentElement.querySelector('.logo-fallback');
                        if (fallback) fallback.style.display = 'flex';
                        logoImg.parentElement.querySelectorAll('.header-logo').forEach(otherLogo => {
                            if (otherLogo !== logoImg) otherLogo.style.display = 'none';
                        });
                    };
                });
            </script>
        </div>
        <div class="header-actions flex items-center space-x-4">
            <a href="/updates_log" class="button button-secondary button-small" title="View All Updates">Updates Log</a>
            <div class="user-info-container flex items-center space-x-3 border-l border-gray-300 dark:border-slate-600 pl-4">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-600 dark:text-slate-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
                <span id="user-display-name" class="text-sm font-medium text-gray-700 dark:text-slate-300">User Name</span>
                <button id="logout-btn" class="button button-danger button-small flex items-center space-x-1" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
                    </svg>
                    <span class="hidden sm:inline">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-col md:flex-row main-flex-container flex-grow p-4 gap-4">
        <nav id="side-nav" class="w-full md:w-56 lg:w-56 p-4 bg-white dark:bg-slate-800 rounded-lg shadow-md flex-shrink-0 relative flex flex-col border border-gray-200 dark:border-slate-700 no-print">
            <div class="flex justify-start items-center mb-3 pb-2 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
                <button id="nav-main-toggle-btn" title="Toggle Navigation" class="p-1 rounded hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                </button>
                <span class="nav-link-text ml-2 text-xs text-gray-500 dark:text-slate-500">MENU</span>
            </div>
            <div id="nav-content" class="flex-grow overflow-y-auto">
                <ul class="space-y-1">
                    <li>
                        <a href="/" title="Dashboard" class="nav-link block py-1.5 text-gray-700 dark:text-slate-300 hover:text-black dark:hover:text-white flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                            <span class="nav-link-text ml-2">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="/forecast" title="View Forecast Page" class="nav-link block py-1.5 text-gray-700 dark:text-slate-300 hover:text-black dark:hover:text-white flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.307a11.95 11.95 0 0 1 5.814-5.519l2.74-1.22m0 0-5.94-2.28m5.94 2.28-2.28 5.941" /></svg>
                            <span class="nav-link-text ml-2">Forecast</span>
                        </a>
                    </li>
                    <li>
                        <a href="/project_gantt" title="View Project Gantt (Requires Project ID)" class="nav-link block py-1.5 text-gray-700 dark:text-slate-300 hover:text-black dark:hover:text-white flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M12 17.25h8.25" /></svg>
                            <span class="nav-link-text ml-2">Gantt Chart</span>
                        </a>
                    </li>
                    <li>
                        <a href="/mrf_form" title="MRF Form" class="nav-link block py-1.5 text-blue-600 dark:text-sky-400 flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded font-semibold bg-gray-100 dark:bg-slate-700">
                            
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
                            </svg>
                            <span class="nav-link-text ml-2">MRF Form</span>
                        </a>
                    </li>
                    <li>
                        <a href="/mrf_items_log" title="MRF Items Log" class="nav-link block py-1.5 text-gray-700 dark:text-slate-300 hover:text-black dark:hover:text-white flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                            </svg>
                            <span class="nav-link-text ml-2">MRF Items Log</span>
                        </a>
                    </li>
                    <li>
                        <a href="/project_mrf_status" title="Project MRF Status" class="nav-link block py-1.5 text-gray-700 dark:text-slate-300 hover:text-black dark:hover:text-white flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 5.25 6.108V18a2.25 2.25 0 0 1 2.25 2.25h.383m12.375-10.206c.073-.076.152-.15.232-.222a21.003 21.003 0 0 0-2.32-2.32c-.072.08-.146.159-.222.232M3.75 7.108c0-1.135.845-2.098 1.976-2.192A48.425 48.425 0 0 1 12 4.5c4.29 0 8.55.655 12.524 1.88a2.25 2.25 0 0 1 1.976 2.192v10.752a2.25 2.25 0 0 1-2.25 2.25H5.25a2.25 2.25 0 0 1-2.25-2.25V7.108Z" />
                            </svg>
                            <span class="nav-link-text ml-2">Project MRF Status</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="mt-auto flex-shrink-0 pt-2 border-t border-gray-200 dark:border-slate-700">
                <button id="settings-toggle-btn" title="Settings" class="nav-link block py-1.5 w-full text-left text-gray-700 dark:text-slate-400 hover:text-black dark:hover:text-slate-200 flex items-center px-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995a6.903 6.903 0 010 1.99c0 .382.145.755.438.995l1.003.827c.447.368.574.984.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.332.183-.582.496-.645-.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.003-.827c.293-.24.438-.613-.438-.995a6.903 6.903 0 010-1.99c0-.382-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.075-.124a6.57 6.57 0 01.22-.127c.332.183-.582.496-.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 0 1 6 0z" /></svg>
                    <span class="nav-link-text ml-2">Settings</span>
                </button>
                <ul id="settings-submenu" class="ml-4 mt-1 hidden space-y-1">
                    <li>
                        <button id="theme-toggle-btn" class="text-xs text-blue-600 dark:text-sky-400 hover:underline">
                            Toggle Theme
                        </button>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="w-full md:flex-1 space-y-4 main-content-area bg-slate-50 dark:bg-slate-800">
          
             <div id="feedbackMessage" class="feedback sticky top-[calc(theme(spacing.12)+1px)] z-10" role="alert"></div> 

            
            <div class="form-container mrf-body-font">
                <header class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <img src="/static/CMRP Logo Dark.svg" alt="CMRP Logo Dark" class="mrf-logo h-10 w-auto block dark:hidden" onerror="this.style.display='none'; this.parentElement.querySelector('.logo-fallback').style.display='flex';">
                            <img src="/static/CMRP Logo Dark.svg" alt="CMRP Logo Dark" class="mrf-logo h-10 w-auto hidden dark:block" onerror="this.style.display='none'; this.parentElement.querySelector('.logo-fallback').style.display='flex';">
                            <div style="display: none;" class="logo-fallback h-10 w-10 bg-blue-200 dark:bg-sky-700 rounded flex items-center justify-center text-sm font-bold text-blue-700 dark:text-sky-200">CMRP</div>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-700 text-center flex-grow">MATERIAL REQUEST FORM</h1>
                        <div class="w-10"></div>
                    </div>
                    <div class="header-section">
                        <div>
                            <dl>
                                <dt>Project Name:</dt>
                                <dd>
                                    <select id="projectName" onchange="populateProjectDetails_MRF(this.value)">
                                        <option value="">Select Project</option>
                                    </select>
                                </dd>
                            </dl>
                            <dl><dt>Project Number:</dt><dd><input type="text" id="projectNumber" placeholder="Auto-populated" readonly></dd></dl>
                            <dl><dt>Client:</dt><dd><input type="text" id="client" placeholder="Auto-populated" readonly></dd></dl>
                            <dl><dt>Site Location:</dt><dd><input type="text" id="siteLocation" placeholder="Enter Site Location"></dd></dl>
                            <dl><dt>Project Phase:</dt><dd><input type="text" id="projectPhase" value="Execution" readonly></dd></dl>
                        </div>
                        <div>
                            <dl>
                                <dt>Form No.:</dt>
                                <dd>
                                    <span id="formNoPrefix" class="header-static-prefix"></span>
                                    <input type="text" id="formNoSuffix" placeholder="001" maxlength="5" size="5">
                                </dd>
                            </dl>
                            <dl><dt>MRF Date:</dt><dd><input type="date" id="mrfDate"></dd></dl>
                        </div>
                    </div>
                </header>

                <main>
                    
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">I. Materials Requested</h2>
                    <div class="table-responsive">
                        <table id="mrfTable">
                            <thead>
                                <tr>
                                    <th style="width: 4%;">No.</th>
                                    <th style="width: 12%;">Part Number</th>
                                    <th style="width: 12%;">Brand Name</th>
                                    <th style="width: 25%;">Description</th>
                                    <th style="width: 7%;" class="text-right">Qty</th>
                                    <th style="width: 7%;">UOM</th>
                                    <th style="width: 10%;">Install. Date</th>
                                    <th style="width: 20%;">Remarks</th>
                                    <th class="no-print" style="width: 3%;">Act</th>
                                </tr>
                            </thead>
                            <tbody id="mrfTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 flex justify-start space-x-2 no-print">
                        <button onclick="addMrfRow()" class="add-row-button">Add Material</button>
                    </div>
                </main>

                <footer class="mt-10 pt-6 border-t border-gray-300 text-xs text-gray-600">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-4">
                        <div>
                            <p class="font-semibold mb-1 footer-label-print">Prepared by:</p>
                            <input type="text" id="footerPreparedByName" placeholder="Name & Signature" class="footer-input">
                            <input type="text" id="footerPreparedByDesignation" placeholder="Designation" class="footer-input">
                        </div>
                        <div>
                            <p class="font-semibold mb-1 footer-label-print">Approved by:</p>
                            <input type="text" id="footerApprovedByName" placeholder="Name & Signature" class="footer-input">
                            <input type="text" id="footerApprovedByDesignation" placeholder="Designation" class="footer-input">
                        </div>
                        <div>
                            <p class="font-semibold mb-1 footer-label-print">Noted by:</p>
                            <input type="text" id="footerNotedByName" placeholder="Name & Signature" class="footer-input">
                            <input type="text" id="footerNotedByDesignation" placeholder="Designation" class="footer-input">
                        </div>
                    </div>
                    <div class="mt-6 text-center text-xs text-gray-500">
                        <p>Page <span id="pageNumber">1</span> of <span id="totalPages">1</span></p>
                    </div>
                    <div class="mt-3 text-center no-print">
                        <button onclick="prepareAndPrint()" class="control-button bg-blue-600 hover:bg-blue-700">Print MRF</button>
                        <button onclick="exportToExcel()" class="control-button export-button">Export to Excel</button>
                        <button onclick="exportToPDF()" class="control-button pdf-export-button">Export to PDF</button>
                        <button onclick="saveDataToServer()" class="control-button save-data-button">Save to DB</button>
                        <button onclick="showLoadModal()" class="control-button load-data-button">Load from DB</button>
                    </div>
                </footer>
            </div> 
        </main>
    </div>

    
    <div id="modals-container">
        
        <div id="loadMrfModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 overflow-y-auto h-full w-full no-print flex items-center justify-center p-4">
            <div class="modal-content relative top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white dark:bg-slate-800">
                <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-slate-700">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-slate-200">Load MRF from Database</h3>
                    <button type="button" id="closeLoadModalBtn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="loadMrfModal">
                        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <div class="mt-2 px-7 py-3">
                    <label for="mrfList" class="block text-sm font-medium text-gray-700 dark:text-slate-300 text-left">Select MRF to Load:</label>
                    <select id="mrfList" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-slate-700 text-gray-900 dark:text-slate-200">
                    </select>
                    <input type="text" id="loadMrfByFormNo" placeholder="Or Enter Form No." class="mt-2 p-2 border rounded-md w-full border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-slate-200 placeholder-gray-400 dark:placeholder-slate-500">
                </div>
                <div class="items-center px-4 py-3 text-center">
                    <button id="confirmLoadMrf" class="button button-success">
                        Load Selected
                    </button>
                    <button id="loadByFormNoBtn" class="button button-primary ml-2">
                        Load by Form No.
                    </button>
                    <button id="cancelLoadModalBtn" type="button" class="button button-secondary ml-2">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    
    <script>
        const API_BASE_URL_MRF = '/api'; // Renamed to avoid conflict if script.js also defines it
        let projectMasterData_MRF = []; // Renamed

        async function fetchProjects_MRF() { // Renamed
            console.log("MRF: Fetching projects from:", `${window.location.origin}${API_BASE_URL_MRF}/projects`);
            try {
                const response = await fetch(`${window.location.origin}${API_BASE_URL_MRF}/projects`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                projectMasterData_MRF = await response.json();
                if (!Array.isArray(projectMasterData_MRF)) {
                    console.error("Fetched project data is not an array:", projectMasterData_MRF);
                    projectMasterData_MRF = []; // Fallback to empty array
                    alert("Received invalid project data from server.");
                }
            } catch (error) {
                console.error("Could not fetch projects for MRF:", error);
                alert("Error fetching project list for MRF. Please ensure the backend is running and you are logged in. Limited functionality.");
                projectMasterData_MRF = []; // Ensure it's an array on error
            }
            populateProjectDropdown_MRF(); // Renamed
            handleUrlParams_MRF(); // Renamed
        }

        function populateProjectDropdown_MRF() { // Renamed
            const projectSelect = document.getElementById('projectName');
            if (!projectSelect) return;
            const currentVal = projectSelect.value;
            projectSelect.innerHTML = '<option value="">Select Project</option>';
            if (!Array.isArray(projectMasterData_MRF)) {
                console.error("projectMasterData_MRF is not an array in populateProjectDropdown_MRF"); return;
            }
            projectMasterData_MRF.forEach(proj => {
                const name = proj.project_name || proj.projectName; // Adapt to potential naming
                if (name) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    projectSelect.appendChild(option);
                }
            });
            if (currentVal && Array.from(projectSelect.options).some(opt => opt.value === currentVal)) {
                projectSelect.value = currentVal;
            }
        }

        function generateAndDisplayFormNo_MRF(projectNumber, loadedFormNo = null) { // Renamed
            const formNoPrefixEl = document.getElementById('formNoPrefix');
            const formNoSuffixEl = document.getElementById('formNoSuffix');
            if (!formNoPrefixEl || !formNoSuffixEl) return;
            const defaultSuffix = "001";

            if (loadedFormNo) {
                const lastHyphenIndex = loadedFormNo.lastIndexOf('-');
                if (lastHyphenIndex > -1 && lastHyphenIndex < loadedFormNo.length - 1) {
                    formNoPrefixEl.textContent = loadedFormNo.substring(0, lastHyphenIndex + 1);
                    formNoSuffixEl.value = loadedFormNo.substring(lastHyphenIndex + 1);
                } else {
                    formNoPrefixEl.textContent = projectNumber ? `${projectNumber}-MRF-` : "PROJECT-MRF-";
                    formNoSuffixEl.value = lastHyphenIndex === -1 ? loadedFormNo : defaultSuffix;
                }
            } else {
                formNoPrefixEl.textContent = projectNumber ? `${projectNumber}-MRF-` : "PROJECT-MRF-";
                formNoSuffixEl.value = defaultSuffix;
            }
        }

        function populateProjectDetails_MRF(selectedProjectName, projectNumberFromParam, clientFromParam, loadedFormNo = null) { //Renamed
            const projectNumberInput = document.getElementById('projectNumber');
            const clientInput = document.getElementById('client');
            const projectPhaseInput = document.getElementById('projectPhase');
            const projectNameSelect = document.getElementById('projectName');
            if (!projectNumberInput || !clientInput || !projectPhaseInput || !projectNameSelect) return;
            let currentProjectNumber = '';

            if (selectedProjectName) {
                const selectedProject = projectMasterData_MRF.find(proj => (proj.project_name || proj.projectName) === selectedProjectName);
                if (selectedProject) {
                    currentProjectNumber = projectNumberFromParam || selectedProject.project_no || selectedProject.projectNumber || '';
                    projectNumberInput.value = currentProjectNumber;
                    clientInput.value = clientFromParam || selectedProject.client || '';
                    projectPhaseInput.value = "Execution";
                    if (projectNameSelect.value !== selectedProjectName) {
                        projectNameSelect.value = selectedProjectName;
                    }
                } else if (projectNumberFromParam !== undefined && clientFromParam !== undefined) {
                    currentProjectNumber = projectNumberFromParam;
                    projectNumberInput.value = currentProjectNumber;
                    clientInput.value = clientFromParam;
                    projectPhaseInput.value = "Execution";
                } else {
                    projectNumberInput.value = ""; clientInput.value = ""; projectPhaseInput.value = "Execution";
                }
            } else {
                projectNumberInput.value = ""; clientInput.value = ""; projectPhaseInput.value = "Execution";
            }
            generateAndDisplayFormNo_MRF(currentProjectNumber, loadedFormNo); //Renamed
        }

        function handleUrlParams_MRF() { // Renamed
            const urlParams = new URLSearchParams(window.location.search);
            const paramProjectName = urlParams.get('project_name');
            const paramProjectNumber = urlParams.get('project_number'); // from API, it's project_no
            const paramClient = urlParams.get('client');
            const projectNameSelect = document.getElementById('projectName');
            const projectNumberInput = document.getElementById('projectNumber');
            const clientInput = document.getElementById('client');

            if (!projectNameSelect || !projectNumberInput || !clientInput) return;


            if (paramProjectName) {
                console.log("MRF URL Params Found:", { paramProjectName, paramProjectNumber, paramClient });

                let optionExists = Array.from(projectNameSelect.options).some(opt => opt.value === paramProjectName);
                if (!optionExists && paramProjectName) { // Ensure paramProjectName is not null/empty before adding
                    const tempOption = document.createElement('option');
                    tempOption.value = paramProjectName; tempOption.textContent = paramProjectName;
                    projectNameSelect.appendChild(tempOption);
                }
                projectNameSelect.value = paramProjectName;
                populateProjectDetails_MRF(paramProjectName, paramProjectNumber, paramClient); // Renamed

                projectNameSelect.disabled = true; projectNumberInput.readOnly = true; clientInput.readOnly = true;
                projectNameSelect.classList.add('bg-gray-100', 'dark:bg-slate-700', 'cursor-not-allowed');
                projectNumberInput.classList.add('bg-gray-100', 'dark:bg-slate-700');
                clientInput.classList.add('bg-gray-100', 'dark:bg-slate-700');
            } else {
                projectNameSelect.disabled = false; projectNumberInput.readOnly = true; clientInput.readOnly = true;
                projectNameSelect.classList.remove('bg-gray-100', 'dark:bg-slate-700', 'cursor-not-allowed');
                generateAndDisplayFormNo_MRF(projectNumberInput.value); // Renamed
            }
        }

        function addMrfRow(data = null) {
            const tableBody = document.getElementById('mrfTableBody');
            if (!tableBody) return;
            const newRow = tableBody.insertRow(-1);
            const defaultValues = {
                itemNo: tableBody.rows.length + 1, partNo: "", brandName: "", description: "",
                qty: "1", uom: "", installDate: new Date().toISOString().split('T')[0], remarks: ""
            };
            const rowData = data && data.values ? data.values : defaultValues;
            if (!data || !data.values) { rowData.itemNo = tableBody.rows.length; }

            newRow.innerHTML = `
                    <td><input type="text" class="table-input" value="${rowData.itemNo}" title="Item Number" readonly></td>
                    <td><input type="text" class="table-input" value="${rowData.partNo || ''}" placeholder="Part Number" title="Part Number"></td>
                    <td><input type="text" class="table-input" value="${rowData.brandName || ''}" placeholder="Brand" title="Brand Name"></td>
                    <td><input type="text" class="table-input" value="${rowData.description || ''}" placeholder="Material Description" title="Description"></td>
                    <td><input type="number" class="table-input number-input" value="${rowData.qty || '1'}" step="1" min="0" title="Quantity"></td>
                    <td><input type="text" class="table-input" value="${rowData.uom || ''}" placeholder="e.g., pc, m, lot" title="Unit of Measure"></td>
                    <td><input type="date" class="table-input" value="${rowData.installDate || new Date().toISOString().split('T')[0]}" title="Target Installation Date"></td>
                    <td><input type="text" class="table-input" value="${rowData.remarks || ''}" placeholder="Remarks" title="Remarks"></td>
                    <td class="no-print"><button class="action-button" onclick="deleteMrfRow(this)" title="Delete Row">Del</button></td>
                `;
            updateRowNumbers_MRF(); // Renamed
        }

        function deleteMrfRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateRowNumbers_MRF(); // Renamed
        }

        function updateRowNumbers_MRF() { // Renamed
            const tableBody = document.getElementById('mrfTableBody');
            if (!tableBody) return;
            Array.from(tableBody.rows).forEach((r, index) => {
                if (r.cells[0] && r.cells[0].querySelector('input')) {
                    r.cells[0].querySelector('input').value = index + 1;
                }
            });
        }

        function toggleInputsToStatic(makeStatic) {
            const formContainer = document.querySelector('.form-container');
            if (!formContainer) return;

            const inputsToToggle = formContainer.querySelectorAll(
                'input[type="text"]:not(#formNoSuffix), input[type="number"], input[type="date"], select, textarea, .footer-input'
            );
            const footerLabels = formContainer.querySelectorAll('.footer-label-print');
            const formNoPrefixEl = formContainer.querySelector('#formNoPrefix');
            const formNoSuffixEl = formContainer.querySelector('#formNoSuffix');
            const formNoSuffixStaticPrintId = 'formNoSuffixStaticPrint';

            inputsToToggle.forEach(input => {
                let staticElement = input.nextElementSibling;
                if (staticElement && (staticElement.tagName === 'INPUT' || staticElement.tagName === 'SELECT' || staticElement.tagName === 'TEXTAREA' || staticElement.id === 'formNoSuffix')) {
                    staticElement = null;
                }
                const isStaticValue = staticElement && staticElement.classList.contains('static-text-value');
                const isTableStaticValue = staticElement && staticElement.classList.contains('table-input-static');
                const isFooterInput = input.classList.contains('footer-input');
                const isHeaderDd = input.closest('.header-section dd');
                const isFormNoContainerMember = input.id === 'formNoPrefix' || input.id === 'formNoSuffix'; // formNoPrefix is a span
                const isHeaderField = isHeaderDd && !isFormNoContainerMember && input.id !== 'formNoSuffix';


                if (makeStatic) {
                    if (!staticElement || !(isStaticValue || isTableStaticValue)) {
                        staticElement = document.createElement(input.tagName === 'TEXTAREA' ? 'pre' : 'span');
                        if (input.classList.contains('table-input')) {
                            staticElement.className = 'table-input-static';
                            if (input.classList.contains('number-input')) staticElement.classList.add('number-input');
                        } else if (isFooterInput) {
                            staticElement.className = 'static-text-value footer-static';
                        } else if (isHeaderField) {
                            staticElement.className = 'static-text-value header-static-print';
                        } else {
                            staticElement.className = 'static-text-value';
                        }
                        if (!isFormNoContainerMember && input.id !== 'formNoSuffix') { // Ensure not to double-wrap suffix
                            input.parentNode.insertBefore(staticElement, input.nextSibling);
                        }
                    }

                    if (input.tagName === 'SELECT') {
                        if (staticElement) staticElement.textContent = input.selectedOptions.length > 0 ? input.selectedOptions[0].text : '';
                    } else if (input.type === 'date' && input.value) {
                        try { if (staticElement) staticElement.textContent = new Date(input.value + 'T00:00:00').toLocaleDateString(); }
                        catch (e) { if (staticElement) staticElement.textContent = input.value; }
                    } else {
                        if (staticElement) staticElement.textContent = input.value;
                    }
                    input.style.display = 'none';
                    if (staticElement) {
                        staticElement.style.display = (isFooterInput || isHeaderField || input.classList.contains('table-input')) ? 'block' : '';
                        if (input.classList.contains('table-input')) staticElement.style.display = 'inline-block';
                    }
                } else {
                    if (staticElement && (isStaticValue || isTableStaticValue)) {
                        staticElement.style.display = 'none';
                    }
                    input.style.display = '';
                }
            });

            if (formNoSuffixEl && formNoPrefixEl) {
                if (makeStatic) {
                    formNoSuffixEl.style.display = 'none';
                    let staticSuffixSpan = formContainer.querySelector(`#${formNoSuffixStaticPrintId}`);
                    if (!staticSuffixSpan) {
                        staticSuffixSpan = document.createElement('span');
                        staticSuffixSpan.id = formNoSuffixStaticPrintId;
                        staticSuffixSpan.style.fontFamily = formNoSuffixEl.style.fontFamily || "'Arial Narrow', 'Inter', sans-serif";
                        staticSuffixSpan.style.fontSize = formNoSuffixEl.style.fontSize || "0.75rem";
                        staticSuffixSpan.style.paddingLeft = "0.1rem";
                        formNoSuffixEl.parentNode.insertBefore(staticSuffixSpan, formNoSuffixEl.nextSibling);
                    }
                    staticSuffixSpan.textContent = formNoSuffixEl.value;
                    staticSuffixSpan.style.display = 'inline';
                    formNoPrefixEl.style.display = 'inline';
                } else {
                    formNoSuffixEl.style.display = '';
                    let staticSuffixSpan = formContainer.querySelector(`#${formNoSuffixStaticPrintId}`);
                    if (staticSuffixSpan) {
                        staticSuffixSpan.style.display = 'none';
                    }
                    formNoPrefixEl.style.display = '';
                }
            }
            footerLabels.forEach(label => {
                if (makeStatic) {
                    if (!label.classList.contains('static-text-value')) {
                        label.classList.add('static-text-value', 'footer-label-static');
                    }
                } else {
                    label.classList.remove('static-text-value', 'footer-label-static');
                }
            });
        }

        function prepareAndPrint() {
            toggleInputsToStatic(true); window.print(); toggleInputsToStatic(false);
        }
        function getFullFormNo_MRF() { // Renamed
            const prefix = document.getElementById('formNoPrefix')?.textContent || "";
            const suffix = document.getElementById('formNoSuffix')?.value || "";
            return `${prefix}${suffix}`;
        }

        function exportToExcel() {
            const formNo = getFullFormNo_MRF() || "MRF_Data"; // Renamed
            const wb = XLSX.utils.book_new(); let sheetData = [];
            const boldStyle = { font: { bold: true, name: "Arial Narrow", sz: 9 } };
            const titleStyle = { font: { bold: true, sz: 14, name: "Arial Narrow" }, alignment: { horizontal: "center" } };
            const headerLabelStyle = { font: { bold: true, name: "Arial Narrow", sz: 8 }, alignment: { horizontal: "left" } };
            const headerValueStyle = { font: { name: "Arial Narrow", sz: 8 }, alignment: { horizontal: "left" } };
            const tableHeaderStyle = { font: { bold: true, name: "Arial Narrow", sz: 8, color: { rgb: "FFFFFF" } }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "4A5568" } }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
            const cellStyle = { font: { name: "Arial Narrow", sz: 8 }, alignment: { vertical: "top" } };
            const centerCellStyle = { ...cellStyle, alignment: { ...cellStyle.alignment, horizontal: "center" } };
            const rightCellStyle = { ...cellStyle, alignment: { ...cellStyle.alignment, horizontal: "right" } };
            sheetData.push([{ v: "MATERIAL REQUEST FORM", s: titleStyle }]); sheetData.push([]);
            const headerFields1 = [
                ["Project Name:", document.getElementById('projectName')?.value],
                ["Project Number:", document.getElementById('projectNumber')?.value],
                ["Client:", document.getElementById('client')?.value],
                ["Site Location:", document.getElementById('siteLocation')?.value],
                ["Project Phase:", document.getElementById('projectPhase')?.value],
            ];
            const headerFields2 = [["Form No.:", formNo], ["MRF Date:", document.getElementById('mrfDate')?.value],];
            const maxHeaderRows = Math.max(headerFields1.length, headerFields2.length);
            for (let i = 0; i < maxHeaderRows; i++) {
                let row = [];
                if (headerFields1[i]) { row.push({ v: headerFields1[i][0], s: headerLabelStyle }); row.push({ v: headerFields1[i][1] || '', s: headerValueStyle }); } else { row.push(null, null); }
                row.push(null);
                if (headerFields2[i]) { row.push({ v: headerFields2[i][0], s: headerLabelStyle }); row.push({ v: headerFields2[i][1] || '', s: headerValueStyle }); } else { row.push(null, null); }
                sheetData.push(row);
            }
            sheetData.push([]);
            sheetData.push([{ v: "I. Materials Requested", s: { ...boldStyle, font: { ...boldStyle.font, sz: 10 } } }]);
            const excelHeaders = ["No.", "Part Number", "Brand Name", "Description", "Qty", "UOM", "Install. Date", "Remarks"];
            sheetData.push(excelHeaders.map(h => ({ v: h, s: tableHeaderStyle })));
            const tableBody = document.getElementById('mrfTableBody');
            if (tableBody) {
                Array.from(tableBody.rows).forEach(tr => {
                    const rowData = []; const inputs = tr.querySelectorAll('input');
                    rowData.push({ v: inputs[0]?.value, s: centerCellStyle }); rowData.push({ v: inputs[1]?.value, s: cellStyle });
                    rowData.push({ v: inputs[2]?.value, s: cellStyle }); rowData.push({ v: inputs[3]?.value, s: cellStyle });
                    rowData.push({ v: parseFloat(inputs[4]?.value) || 0, t: 'n', s: rightCellStyle });
                    rowData.push({ v: inputs[5]?.value, s: centerCellStyle }); rowData.push({ v: inputs[6]?.value, s: centerCellStyle });
                    rowData.push({ v: inputs[7]?.value, s: cellStyle }); sheetData.push(rowData);
                });
            }
            sheetData.push([]);
            const signatories = [
                ["Prepared by:", document.getElementById('footerPreparedByName')?.value, document.getElementById('footerPreparedByDesignation')?.value],
                ["Approved by:", document.getElementById('footerApprovedByName')?.value, document.getElementById('footerApprovedByDesignation')?.value],
                ["Noted by:", document.getElementById('footerNotedByName')?.value, document.getElementById('footerNotedByDesignation')?.value]
            ];
            signatories.forEach(sigSet => {
                sheetData.push([{ v: sigSet[0], s: { ...boldStyle, font: { ...boldStyle.font, sz: 9 } } }]);
                sheetData.push([null, { v: sigSet[1] || '', s: { ...cellStyle, font: { ...cellStyle.font, sz: 9 } } }]);
                sheetData.push([null, { v: sigSet[2] || '', s: { ...cellStyle, font: { ...cellStyle.font, sz: 9 } } }]);
                sheetData.push([]);
            });
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            ws['!cols'] = [{ wch: 5 }, { wch: 15 }, { wch: 15 }, { wch: 35 }, { wch: 8 }, { wch: 8 }, { wch: 12 }, { wch: 30 }];
            const merges = [{ s: { r: 0, c: 0 }, e: { r: 0, c: excelHeaders.length - 1 } }]; ws['!merges'] = merges;
            XLSX.utils.book_append_sheet(wb, ws, "Material Request Form");
            XLSX.writeFile(wb, `${formNo.replace(/[^a-z0-9_.-]/gi, '_')}.xlsx`);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf; const content = document.querySelector(".form-container");
            const buttonsToHide = document.querySelectorAll(".no-print");
            buttonsToHide.forEach(btn => btn.style.visibility = 'hidden'); toggleInputsToStatic(true);
            html2canvas(content, { scale: 2, useCORS: true, logging: true, onclone: (clonedDoc) => { clonedDoc.querySelectorAll(".no-print").forEach(el => el.style.display = 'none'); } })
                .then(canvas => {
                    const imgData = canvas.toDataURL('image/png', 0.95); const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                    const imgProps = pdf.getImageProperties(imgData); const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight(); const margin = 25;
                    const usableWidth = pdfWidth - (2 * margin); const usableHeight = pdfHeight - (2 * margin);
                    const imgWidth = imgProps.width; const imgHeight = imgProps.height;
                    const widthRatio = usableWidth / imgWidth; const heightRatio = usableHeight / imgHeight;
                    const ratio = Math.min(widthRatio, heightRatio); const finalImgWidth = imgWidth * ratio;
                    let currentY = 0;
                    while (currentY < canvas.height) {
                        let sliceHeight = Math.min(canvas.height - currentY, (usableHeight / ratio));
                        const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvas.width; tempCanvas.height = sliceHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(canvas, 0, currentY, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
                        const pageImgData = tempCanvas.toDataURL('image/png', 0.95);
                        if (currentY > 0) pdf.addPage('a4', 'portrait');
                        pdf.addImage(pageImgData, 'PNG', margin, margin, finalImgWidth, sliceHeight * ratio);
                        currentY += sliceHeight;
                    }
                    buttonsToHide.forEach(btn => btn.style.visibility = 'visible'); toggleInputsToStatic(false);
                    const formNo = getFullFormNo_MRF() || "MRF_Form"; // Renamed
                    pdf.save(`${formNo.replace(/[^a-z0-9_.-]/gi, '_')}.pdf`);
                }).catch(err => {
                    console.error("Error during PDF export:", err);
                    buttonsToHide.forEach(btn => btn.style.visibility = 'visible'); toggleInputsToStatic(false);
                    alert("Error generating PDF. Please check the console for details.");
                });
        }

        async function saveDataToServer() {
            const dataToSave = { header: {}, tableRows: [], footerSignatories: {} };
            const headerIds = ['projectNumber', 'projectName', 'client', 'siteLocation', 'projectPhase', 'mrfDate'];
            headerIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) { if (element.tagName === 'SELECT') { dataToSave.header[id] = element.value; } else { dataToSave.header[id] = element.value; } }
            });
            dataToSave.header.formNo = getFullFormNo_MRF(); // Renamed
            const tableBody = document.getElementById('mrfTableBody');
            if (tableBody) {
                Array.from(tableBody.rows).forEach(tr => {
                    const inputs = tr.querySelectorAll('input');
                    dataToSave.tableRows.push({ values: { itemNo: inputs[0].value, partNo: inputs[1].value, brandName: inputs[2].value, description: inputs[3].value, qty: inputs[4].value, uom: inputs[5].value, installDate: inputs[6].value, remarks: inputs[7].value } });
                });
            }
            ['footerPreparedByName', 'footerPreparedByDesignation', 'footerApprovedByName', 'footerApprovedByDesignation', 'footerNotedByName', 'footerNotedByDesignation']
                .forEach(id => dataToSave.footerSignatories[id] = document.getElementById(id)?.value);
            console.log("Data to save:", JSON.stringify(dataToSave, null, 2));
            const formNoPrefix = document.getElementById('formNoPrefix')?.textContent || "";
            const formNoSuffixValue = document.getElementById('formNoSuffix')?.value.trim() || "";
            if (!formNoSuffixValue) { alert("Form No. suffix is required."); return; }
            if (formNoPrefix === "PROJECT-MRF-" && formNoSuffixValue === "001") { alert("Please select a project or ensure the suffix is not default '001' for a generic MRF."); return; }
            if (!dataToSave.header.formNo || dataToSave.header.formNo.trim() === "" || dataToSave.header.formNo === "PROJECT-MRF-001") {
                if (formNoPrefix === "PROJECT-MRF-" && formNoSuffixValue === "001") { alert("Form No. appears to be a placeholder. Please select a project or ensure the suffix is not the default '001' for a generic MRF."); return; }
            }
            try {
                const response = await fetch(`${window.location.origin}${API_BASE_URL_MRF}/mrf`, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify(dataToSave), });
                const result = await response.json();
                if (response.ok) { alert(`MRF saved successfully! Form No: ${result.form_no}`); }
                else { alert(`Error saving MRF: ${result.error} - ${result.details || ''}`); }
            } catch (error) {
                console.error("Error saving MRF to server:", error);
                alert("Failed to connect to the server to save MRF. Ensure the backend is running and you are logged in.");
            }
        }

        async function loadMrfDataFromServer(formNoToLoad) {
            if (!formNoToLoad) { alert("Please enter a Form No. to load."); return; }
            console.log(`Loading MRF: ${formNoToLoad} from ${window.location.origin}${API_BASE_URL_MRF}/mrf/${formNoToLoad}`);
            try {
                const response = await fetch(`${window.location.origin}${API_BASE_URL_MRF}/mrf/${formNoToLoad}`);
                if (!response.ok) { const errorData = await response.json(); throw new Error(`HTTP error! status: ${response.status} - ${errorData.error || 'MRF not found or server error'}`); }
                const mrfData = await response.json();
                populateFormWithData_MRF(mrfData); // Renamed
                const modal = document.getElementById('loadMrfModal');
                if (modal) modal.classList.add('hidden');
            } catch (error) { console.error("Could not load MRF:", error); alert(`Error loading MRF: ${error.message}`); }
        }

        function populateFormWithData_MRF(data) { // Renamed
            if (!data) return; let loadedFullFormNo = null; let projectNumberForFormNo = "";
            if (data.header) {
                if (data.header.formNo) { loadedFullFormNo = data.header.formNo; }
                projectNumberForFormNo = data.header.projectNumber || "";
                for (const id in data.header) {
                    if (id === 'formNo') continue;
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = data.header[id] !== undefined && data.header[id] !== null ? data.header[id] : "";
                        if (id === 'projectName' && el.tagName === 'SELECT') {
                            let optionExists = Array.from(el.options).some(opt => opt.value === data.header[id]);
                            if (!optionExists && data.header[id]) { const tempOption = document.createElement('option'); tempOption.value = data.header[id]; tempOption.textContent = data.header[id]; el.appendChild(tempOption); }
                            el.value = data.header[id];
                            populateProjectDetails_MRF(data.header[id], data.header.projectNumber, data.header.client, loadedFullFormNo); // Renamed
                        }
                    }
                }
                const projectNameFromForm = document.getElementById('projectName')?.value;
                if (!projectNameFromForm && loadedFullFormNo) { generateAndDisplayFormNo_MRF(projectNumberForFormNo, loadedFullFormNo); } // Renamed
                else if (loadedFullFormNo && (getFullFormNo_MRF() !== loadedFullFormNo)) { generateAndDisplayFormNo_MRF(projectNumberForFormNo, loadedFullFormNo); } // Renamed
                else if (!loadedFullFormNo) { generateAndDisplayFormNo_MRF(projectNumberForFormNo); } // Renamed
            } else if (data.formNo) { generateAndDisplayFormNo_MRF(document.getElementById('projectNumber')?.value, data.formNo); } // Renamed

            const tableBody = document.getElementById('mrfTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (data.tableRows && Array.isArray(data.tableRows)) {
                if (data.tableRows.length > 0) { data.tableRows.forEach(rowData => { if (rowData && rowData.values) { addMrfRow(rowData); } else { console.warn("Skipping row in tableRows:", rowData); } }); }
                else { addMrfRow(); }
            } else { console.warn("data.tableRows missing or not array. Adding default row."); addMrfRow(); }

            if (data.footerSignatories) {
                for (const id in data.footerSignatories) { const el = document.getElementById(id); if (el) el.value = data.footerSignatories[id] !== undefined && data.footerSignatories[id] !== null ? data.footerSignatories[id] : ""; }
            }
        }

        function setupModalInteractions() {
            const loadMrfModalEl = document.getElementById('loadMrfModal');
            const mrfListSelectEl = document.getElementById('mrfList');
            const confirmLoadMrfBtnEl = document.getElementById('confirmLoadMrf');
            const closeLoadModalBtnEl = document.getElementById('closeLoadModalBtn'); // Using ID from the new modal structure
            const cancelLoadModalBtnEl = document.getElementById('cancelLoadModalBtn'); // Using ID from the new modal structure
            const loadMrfByFormNoInputEl = document.getElementById('loadMrfByFormNo');
            const loadByFormNoBtnEl = document.getElementById('loadByFormNoBtn');

            if (confirmLoadMrfBtnEl && mrfListSelectEl) {
                confirmLoadMrfBtnEl.addEventListener('click', () => {
                    const selectedFormNo = mrfListSelectEl.value;
                    if (selectedFormNo) { loadMrfDataFromServer(selectedFormNo); } else { alert("Please select an MRF from the list."); }
                });
            }
            if (loadByFormNoBtnEl && loadMrfByFormNoInputEl) {
                loadByFormNoBtnEl.addEventListener('click', () => {
                    const formNoFromInput = loadMrfByFormNoInputEl.value.trim();
                    if (formNoFromInput) { loadMrfDataFromServer(formNoFromInput); } else { alert("Please enter a Form No. to load."); }
                });
            }
            const closeModalHandler = () => { if (loadMrfModalEl) { loadMrfModalEl.classList.add('hidden'); loadMrfModalEl.classList.remove('flex'); } };
            if (closeLoadModalBtnEl) closeLoadModalBtnEl.addEventListener('click', closeModalHandler);
            if (cancelLoadModalBtnEl) cancelLoadModalBtnEl.addEventListener('click', closeModalHandler);

            if (loadMrfModalEl) {
                loadMrfModalEl.addEventListener('click', (event) => {
                    // Close if clicking on the backdrop (the modal itself)
                    if (event.target === loadMrfModalEl) { closeModalHandler(); }
                });
            }
        }
        function showLoadModal() {
            const loadMrfModalEl = document.getElementById('loadMrfModal');
            const mrfListSelectEl = document.getElementById('mrfList');
            if (!loadMrfModalEl || !mrfListSelectEl) return;

            loadMrfModalEl.classList.remove('hidden');
            loadMrfModalEl.classList.add('flex'); // Make it flex to center content

            mrfListSelectEl.innerHTML = '<option value="">Loading MRFs...</option>';
            fetch(`${window.location.origin}${API_BASE_URL_MRF}/mrfs`) // Use MRF-specific API URL
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch MRF list');
                    return response.json();
                })
                .then(mrfs => {
                    mrfListSelectEl.innerHTML = '<option value="">Select MRF from list</option>';
                    if (Array.isArray(mrfs)) {
                        mrfs.forEach(mrf => {
                            const option = document.createElement('option');
                            option.value = mrf.form_no;
                            option.textContent = `${mrf.form_no} - ${mrf.project_name || 'N/A'} (${mrf.mrf_date || 'N/A'})`;
                            mrfListSelectEl.appendChild(option);
                        });
                    } else {
                        console.error("Fetched MRFs is not an array: ", mrfs);
                        mrfListSelectEl.innerHTML = '<option value="">Error loading list</option>';
                    }
                })
                .catch(error => {
                    console.error("Error populating MRF list:", error);
                    mrfListSelectEl.innerHTML = '<option value="">Could not load MRF list</option>';
                });
        }


        document.addEventListener('DOMContentLoaded', function () {
            // Initialize general page elements (like in script.js)
            const navToggleBtn = document.getElementById('nav-main-toggle-btn'); // from index.html shell
            const sideNav = document.getElementById('side-nav'); // from index.html shell
            const settingsToggleBtn = document.getElementById('settings-toggle-btn'); // from index.html shell
            const settingsSubMenu = document.getElementById('settings-submenu'); // from index.html shell
            const themeToggleBtn = document.getElementById('theme-toggle-btn'); // from index.html shell
            const mainThemeToggleBtn = document.querySelector('.app-header #theme-toggle-btn-header') || document.getElementById('theme-toggle-btn-header'); // header button
            const userDisplay = document.getElementById('user-display-name');
            const logoutBtn = document.getElementById('logout-btn');


            if (navToggleBtn && sideNav) {
                navToggleBtn.addEventListener('click', () => {
                    sideNav.classList.toggle('nav-collapsed');
                    localStorage.setItem('navCollapsed', sideNav.classList.contains('nav-collapsed'));
                });
                if (localStorage.getItem('navCollapsed') === 'true') {
                    sideNav.classList.add('nav-collapsed');
                }
            }

            if (settingsToggleBtn && settingsSubMenu) {
                settingsToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent event from bubbling up to document click listener
                    settingsSubMenu.classList.toggle('hidden');
                });
            }
            // Theme toggle
            const applyTheme = (isDark) => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };
            const toggleTheme = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                applyTheme(isDark); // Ensure theme is applied immediately
                // Also update MRF logo visibility based on new theme
                if (isDark) {
                    document.querySelectorAll('.header-logo.block.dark\\:hidden').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.header-logo.hidden.dark\\:block').forEach(el => el.style.display = 'block');
                } else {
                    document.querySelectorAll('.header-logo.block.dark\\:hidden').forEach(el => el.style.display = 'block');
                    document.querySelectorAll('.header-logo.hidden.dark\\:block').forEach(el => el.style.display = 'none');
                }
            };
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (mainThemeToggleBtn) mainThemeToggleBtn.addEventListener('click', toggleTheme);


            // Logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`${window.location.origin}/api/logout`, { method: 'POST' });
                        const data = await response.json();
                        if (response.ok) {
                            alert(data.message || "Logout successful.");
                            window.location.href = `${window.location.origin}/login`;
                        } else {
                            alert("Logout failed: " + (data.error || "Unknown error"));
                        }
                    } catch (error) {
                        console.error("Logout error:", error);
                        alert("Logout request failed. Check network or console.");
                    }
                });
            }
            // Fetch user profile
            fetch(`${window.location.origin}/api/user/profile`)
                .then(response => response.json())
                .then(data => {
                    if (data.username && userDisplay) {
                        userDisplay.textContent = data.username + (data.role ? ` (${data.role})` : '');
                    }
                }).catch(err => console.error("Error fetching user profile:", err));


            // MRF form specific initializations
            document.querySelectorAll('.mrf-logo').forEach(logoImg => {
                logoImg.onerror = () => {
                    logoImg.style.display = 'none';
                    const fallback = logoImg.parentElement.querySelector('.logo-fallback');
                    if (fallback) fallback.style.display = 'flex';
                    // Hide the other variant too if this one fails
                    logoImg.parentElement.querySelectorAll('.mrf-logo').forEach(otherLogo => {
                        if (otherLogo !== logoImg) otherLogo.style.display = 'none';
                    });
                };
            });

            fetchProjects_MRF(); // Fetch projects for MRF dropdown
            addMrfRow(); // Add initial row to MRF table

            const mrfDateInput = document.getElementById('mrfDate');
            if (mrfDateInput && !mrfDateInput.value) {
                mrfDateInput.value = new Date().toISOString().split('T')[0];
            }
            if (!new URLSearchParams(window.location.search).has('project_name')) {
                const projectPhaseEl = document.getElementById('projectPhase');
                if (projectPhaseEl) projectPhaseEl.value = "Execution";
                generateAndDisplayFormNo_MRF(""); // Renamed
            }
            setupModalInteractions(); // For the "Load from DB" modal

            // Ensure correct logo visibility on initial load based on theme for main header
            const initialIsDark = document.documentElement.classList.contains('dark');
            const mainLightLogo = document.querySelector('.app-header img.header-logo[src="/static/CMRP Logo Dark.svg"]');
            const mainDarkLogo = document.querySelector('.app-header img.header-logo[src="/static/CMRP Logo Light.svg"]');
            if (mainLightLogo) mainLightLogo.style.display = initialIsDark ? 'none' : 'block';
            if (mainDarkLogo) mainDarkLogo.style.display = initialIsDark ? 'block' : 'none';

            // For MRF form's internal logos, Tailwind classes block/dark:hidden should handle it.
            // No specific JS needed here if HTML is set up correctly.
        });
    </script>
    
    <script src="script.js" defer></script> 
</body>
</html>
